import streamlit as st
import numpy as np
import plotly.graph_objects as go

st.set_page_config(page_title="ржмрж╛ржВрж▓рж╛ржжрзЗрж╢ AQI ржкрзНрж░рзЗржбрж┐ржХрзНржЯрж░", page_icon="ЁЯМН", layout="centered")

st.title("ЁЯМН рж░рж┐ржпрж╝рзЗрж▓-ржЯрж╛ржЗржо ржПржпрж╝рж╛рж░ ржХрзЛржпрж╝рж╛рж▓рж┐ржЯрж┐ ржЗржиржбрзЗржХрзНрж╕ (AQI) ржкрзНрж░рзЗржбрж┐ржХрзНржЯрж░")
st.markdown("ржирж┐ржЪрзЗ рждрзЛржорж╛рж░ рж╕рзЗржирзНрж╕рж░ ржмрж╛ ржкрж░рж┐ржорж╛ржкрзЗрж░ ржбрж╛ржЯрж╛ ржжрж╛ржУ тАФ ржЖржорж┐ AQI ржмрж▓рзЗ ржжрж┐ржЪрзНржЫрж┐ + ржХрзА ржХрж░рж╛ ржЙржЪрж┐ржд рждрж╛ржУ ржмрж▓ржЫрж┐")

col1, col2 = st.columns(2)

with col1:
    st.subheader("ржмрж╛ржпрж╝рзБрж░ ржЙржкрж╛ржжрж╛ржи (Pollutants)")
    pm25 = st.number_input("PM2.5 (┬╡g/m┬│)", 0.0, 1000.0, 25.0, step=0.1)
    pm10 = st.number_input("PM10 (┬╡g/m┬│)", 0.0, 1000.0, 54.0, step=0.1)
    co_ppm = st.number_input("CO (ppm)", 0.0, 50.0, 1.0, step=0.1)
    o3_ppb = st.number_input("OтВГ (ppb)", 0.0, 400.0, 60.0, step=1.0)
    no2_ppb = st.number_input("NOтВВ (ppb)", 0.0, 1000.0, 40.0, step=1.0)

with col2:
    st.subheader("ржЖржмрж╣рж╛ржУржпрж╝рж╛ (Weather)")
    temp = st.number_input("рждрж╛ржкржорж╛рждрзНрж░рж╛ (┬░C)", -10.0, 50.0, 28.0, step=0.5)
    humidity = st.number_input("ржЖрж░рзНржжрзНрж░рждрж╛ (%)", 0.0, 100.0, 70.0, step=1.0)

# тАФтАФтАФтАФтАФтАФтАФтАФтАФтАФ US EPA AQI ржХрзНржпрж╛рж▓ржХрзБрж▓рзЗрж╢ржи ржлрж╛ржВрж╢ржи тАФтАФтАФтАФтАФтАФтАФтАФтАФтАФ
def calculate_sub_aqi(C, breakpoints):
    for (low_c, high_c, low_i, high_i) in breakpoints:
        if low_c <= C <= high_c:
            return low_i + (high_i - low_i) * (C - low_c) / (high_c - low_c)
    return 500 if C > breakpoints[-1][1] else 0

def get_aqi(pm25=None, pm10=None, co=None, o3=None, no2=None):
    aqi_list = []

    # PM2.5
    if pm25 is not None:
        bp_pm25 = [(0,12,0,50), (12.1,35.4,51,100), (35.5,55.4,101,150), 
                   (55.5,150.4,151,200), (150.5,250.4,201,300), (250.5,500.4,301,500)]
        aqi_list.append(("PM2.5", calculate_sub_aqi(pm25, bp_pm25)))

    # PM10
    if pm10 is not None:
        bp_pm10 = [(0,54,0,50), (55,154,51,100), (155,254,101,150), 
                   (255,354,151,200), (355,424,201,300), (425,604,301,500)]
        aqi_list.append(("PM10", calculate_sub_aqi(pm10, bp_pm10)))

    # CO (ppm тЖТ 8-hour average ржП ржХржиржнрж╛рж░рзНржЯ ржХрж░рж╛рж░ рж╕рж╣ржЬ ржЙржкрж╛ржпрж╝)
    if co is not None:
        bp_co = [(0,4.4,0,50), (4.5,9.4,51,100), (9.5,12.4,101,150), 
                 (12.5,15.4,151,200), (15.5,30.4,201,300), (30.5,50.4,301,500)]
        aqi_list.append(("CO", calculate_sub_aqi(co, bp_co)))

    # OтВГ (ppb)
    if o3 is not None:
        bp_o3 = [(0,54,0,50), (55,70,51,100), (71,85,101,150), 
                 (86,105,151,200), (106,200,201,300), (201,604,301,500)]
        aqi_list.append(("OтВГ", calculate_sub_aqi(o3, bp_o3)))

    # NOтВВ (ppb)
    if no2 is not None:
        bp_no2 = [(0,53,0,50), (54,100,51,100), (101,360,101,150), 
                  (361,649,151,200), (650,1249,201,300), (1250,2049,301,500)]
        aqi_list.append(("NOтВВ", calculate_sub_aqi(no2, bp_no2)))

    if not aqi_list:
        return 0, "ржХрзЛржирзЛ ржбрж╛ржЯрж╛ ржирзЗржЗ"
    
    overall_aqi = max([x[1] for x in aqi_list])
    main_pollutant = [x[0] for x in aqi_list if x[1] == overall_aqi][0]
    
    return round(overall_aqi), main_pollutant

# ржкрзНрж░рзЗржбрж┐ржХрзНржЯ ржмрж╛ржЯржи
if st.button("AQI ржжрзЗржЦрж╛ржУ тЖТ", type="primary", use_container_width=True):
    aqi, pollutant = get_aqi(pm25, pm10, co_ppm, o3_ppb, no2_ppb)

    # ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐ ржУ ржХрж╛рж▓рж╛рж░
    if aqi <= 50:
        cat = "ржнрж╛рж▓рзЛ"; color = "#00e400"; bg = "lightgreen"
    elif aqi <= 100:
        cat = "ржорзЛржЯрж╛ржорзБржЯрж┐"; color = "#ffff00"; bg = "yellow"
    elif aqi <= 150:
        cat = "рж╕ржВржмрзЗржжржирж╢рзАрж▓ржжрзЗрж░ ржЬржирзНржп ржЕрж╕рзНржмрж╛рж╕рзНржерзНржпржХрж░"; color = "#ff7e00"; bg = "orange"
    elif aqi <= 200:
        cat = "ржЕрж╕рзНржмрж╛рж╕рзНржерзНржпржХрж░"; color = "#ff0000"; bg = "lightcoral"
    elif aqi <= 300:
        cat = "ржЦрзБржм ржЕрж╕рзНржмрж╛рж╕рзНржерзНржпржХрж░"; color = "#8f3f97"; bg = "#d3a4d8"
    else:
        cat = "ржмрж┐ржкржЬрзНржЬржиржХ"; color = "#7e0023"; bg = "#ffcccc"

    # ржЧржЬ ржЪрж╛рж░рзНржЯ
    fig = go.Figure(go.Indicator(
        mode="gauge+number+delta",
        value=aqi,
        number={'font': {'size': 60, 'color': color}},
        delta={'reference': 100, 'position': "top"},
        gauge={
            'axis': {'range': [0, 500], 'tickwidth': 2, 'tickcolor': "darkblue"},
            'bar': {'color': color},
            'bgcolor': "white",
            'borderwidth': 2,
            'bordercolor': "gray",
            'steps': [
                {'range': [0, 50], 'color': '#00e400'},
                {'range': [51, 100], 'color': '#ffff00'},
                {'range': [101, 150], 'color': '#ff7e00'},
                {'range': [151, 200], 'color': '#ff0000'},
                {'range': [201, 300], 'color': '#8f3f97'},
                {'range': [301, 500], 'color': '#7e0023'}
            ]
        },
        title={'text': f"<b>AQI: {aqi}</b> тЖТ {cat}<br><span style='font-size:18px'>ржорзВрж▓ ржжрзВрж╖ржХ: {pollutant}</span>", 'font': {'size': 22}}
    ))
    fig.update_layout(height=500)
    st.plotly_chart(fig, use_container_width=True)

    # ржмрж╛ржВрж▓рж╛ржпрж╝ рж╕рж╛ржЬрзЗрж╢ржи
    st.markdown("### рж╕рзНржмрж╛рж╕рзНржерзНржп рж╕рзБржкрж╛рж░рж┐рж╢")
    suggestions = {
        "ржнрж╛рж▓рзЛ": "ржмрж╛рждрж╛рж╕ ржПржХржжржо ржнрж╛рж▓рзЛ ржЖржЫрзЗред ржмрж╛ржЗрж░рзЗ ржЦрзЗрж▓рж╛ржзрзБрж▓рж╛, рж╣рж╛ржБржЯрж╛-ржЪрж▓рж╛ ржХрж░рждрзЗ ржкрж╛рж░рзЛред",
        "ржорзЛржЯрж╛ржорзБржЯрж┐": "рж╕рж╛ржзрж╛рж░ржгржд ржирж┐рж░рж╛ржкржжред рждржмрзЗ рж╢рзНржмрж╛рж╕ржХрж╖рзНржЯ ржмрж╛ рж╣рж╛ржБржкрж╛ржирж┐рж░ рж░рзЛржЧрзА рж╕рждрж░рзНржХ ржерж╛ржХрзБржиред",
        "рж╕ржВржмрзЗржжржирж╢рзАрж▓ржжрзЗрж░ ржЬржирзНржп ржЕрж╕рзНржмрж╛рж╕рзНржерзНржпржХрж░": "рж╢рж┐рж╢рзБ, ржмрзГржжрзНржз, рж╣рж╛ржБржкрж╛ржирж┐/рж╣рзГржжрж░рзЛржЧрзА ржмрзНржпржХрзНрждрж┐рж░рж╛ ржмрж╛ржЗрж░рзЗрж░ ржХрж╛рж░рзНржпржХрж▓рж╛ржк ржХржорж┐ржпрж╝рзЗ ржжрж┐ржиред",
        "ржЕрж╕рзНржмрж╛рж╕рзНржерзНржпржХрж░": "рж╕ржмрж╛ржЗ ржмрж╛ржЗрж░рзЗрж░ ржХрж╛рж░рзНржпржХрж▓рж╛ржк ржХржорж╛ржиред N95 ржорж╛рж╕рзНржХ ржкрж░рзБржиред рж╢рж┐рж╢рзБржжрзЗрж░ ржШрж░рзЗ рж░рж╛ржЦрзБржиред",
        "ржЦрзБржм ржЕрж╕рзНржмрж╛рж╕рзНржерзНржпржХрж░": "ржмрж╛ржЗрж░рзЗ ржмрзЗрж░ рж╣ржУржпрж╝рж╛ ржПржХржжржо ржПржбрж╝рж┐ржпрж╝рзЗ ржЪрж▓рзБржиред ржШрж░рзЗрж░ ржЬрж╛ржирж╛рж▓рж╛ ржмржирзНржз рж░рж╛ржЦрзБржиред ржПржпрж╝рж╛рж░ ржкрж┐ржЙрж░рж┐ржлрж╛ржпрж╝рж╛рж░ ржЪрж╛рж▓рж╛ржиред",
        "ржмрж┐ржкржЬрзНржЬржиржХ": "ржЬрж░рзБрж░рж┐ ржЕржмрж╕рзНржерж╛! рж╕ржмрж╛ржЗ ржШрж░рзЗ ржерж╛ржХрзБржиред ржмрж╛ржЗрж░рзЗ ржмрзЗрж░ рж╣рж▓рзЗ N95/KN95 ржорж╛рж╕рзНржХ ржЕржмрж╢рзНржпржЗ ржкрж░рзБржиред"
    }
    st.success(suggestions[cat])

st.markdown("---")
st.caption("рждрзИрж░рж┐ ржХрж░рзЗржЫрзЗржи рждрзЛржорж╛рж░ ржирж╛ржо тЭдя╕П | ржбрж╛ржЯрж╛ рж╕рзЛрж░рзНрж╕: US EPA AQI Standard | рж▓рж╛ржЗржн ржбрзЗржорзЛ: рждрзЛржорж╛рж░ рж▓рж┐ржЩрзНржХ")
